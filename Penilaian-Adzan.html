<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rekap Penilaian Peserta - Lomba Hadroh</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h1 { text-align: center; margin-bottom: 20px; }
table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
th, td { border: 1px solid #000; padding: 5px; text-align: center; }
th { background-color: #f2f2f2; cursor: pointer; }
input.nilai, input.nama { width: 60px; text-align: center; }
input.nama { width: 120px; text-align: left; }
button { margin: 5px; padding: 5px 10px; cursor: pointer; }
#filterInput { width: 200px; padding: 5px; margin-bottom: 10px; }
</style>
</head>
<body>

<h1>Rekap Penilaian Peserta - Lomba Hadroh</h1>

<p>Filter Nama / Group: <input type="text" id="filterInput" placeholder="Ketik nama atau grup..."></p>

<table id="pesertaTable">
    <thead>
        <tr>
            <th>No</th>
            <th>Nama Peserta / Group</th>
            <th>Kekompakan</th>
            <th>Variasi Lagu</th>
            <th>Harmonisasi Nada</th>
            <th>Kesesuaian Tempo</th>
            <th>Total</th>
        </tr>
    </thead>
    <tbody>
        <!-- Baris peserta dibuat otomatis JS -->
    </tbody>
</table>

<button id="saveAllBtn">Simpan Semua Nilai</button>
<button id="downloadAllBtn">Download Semua PDF</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
// Buat 50 peserta
const tbody = document.querySelector('#pesertaTable tbody');
for(let i=1;i<=50;i++){
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td>${i}</td>
        <td><input type="text" class="nama" placeholder="Nama peserta ${i}"></td>
        <td><input type="number" class="nilai" min="0" max="100"></td>
        <td><input type="number" class="nilai" min="0" max="100"></td>
        <td><input type="number" class="nilai" min="0" max="100"></td>
        <td><input type="number" class="nilai" min="0" max="100"></td>
        <td><input type="number" class="total" readonly></td>
    `;
    tbody.appendChild(tr);
}

// Load dari localStorage
for(let i=1;i<=50;i++){
    const data = JSON.parse(localStorage.getItem('peserta_'+i));
    if(data){
        const row = tbody.children[i-1];
        row.querySelector('.nama').value = data.nama;
        const nilaiInputs = row.querySelectorAll('.nilai');
        nilaiInputs.forEach((input,index)=> input.value = data.nilai[index]);
        row.querySelector('.total').value = data.total;
    }
}

// Hitung total per baris
function updateTotal(row){
    let total = 0;
    row.querySelectorAll('.nilai').forEach(input => total += parseFloat(input.value)||0);
    row.querySelector('.total').value = total;
}

// Event listener input nilai
document.querySelectorAll('input.nilai').forEach(input=>{
    input.addEventListener('input', ()=>{
        const row = input.closest('tr');
        updateTotal(row);
        saveRow(row);
    });
});

// Simpan satu baris
function saveRow(row){
    const index = Array.from(tbody.children).indexOf(row)+1;
    const nama = row.querySelector('.nama').value;
    const nilaiArr = Array.from(row.querySelectorAll('.nilai')).map(i=>parseFloat(i.value)||0);
    const total = row.querySelector('.total').value;
    localStorage.setItem('peserta_'+index, JSON.stringify({nama, nilai: nilaiArr, total}));
}

// Tombol simpan semua
document.getElementById('saveAllBtn').addEventListener('click', ()=>{
    tbody.querySelectorAll('tr').forEach(saveRow);
    alert('Semua nilai tersimpan di browser!');
});

// Tombol download semua PDF
document.getElementById('downloadAllBtn').addEventListener('click', async ()=>{
    for(let i=0;i<tbody.children.length;i++){
        const row = tbody.children[i];
        const element = document.createElement('div');
        element.style.padding='10px';
        element.innerHTML = `
            <h2>Penilaian Peserta</h2>
            <p><strong>No Peserta:</strong> ${i+1}</p>
            <p><strong>Nama:</strong> ${row.querySelector('.nama').value}</p>
            <table border="1" style="border-collapse:collapse; width:100%;">
                <tr><th>Aspek</th><th>Nilai</th></tr>
                <tr><td>Kekompakan</td><td>${row.children[2].querySelector('input').value}</td></tr>
                <tr><td>Variasi Lagu</td><td>${row.children[3].querySelector('input').value}</td></tr>
                <tr><td>Harmonisasi Nada</td><td>${row.children[4].querySelector('input').value}</td></tr>
                <tr><td>Kesesuaian Tempo</td><td>${row.children[5].querySelector('input').value}</td></tr>
                <tr><td>Total</td><td>${row.children[6].querySelector('input').value}</td></tr>
            </table>
        `;
        await html2pdf().set({margin:0.5, filename:`Penilaian_Peserta_${i+1}.pdf`, jsPDF:{unit:'in',format:'a4',orientation:'portrait'}}).from(element).save();
    }
    alert('Semua PDF telah di-download!');
});

// Filter peserta
document.getElementById('filterInput').addEventListener('input', function(){
    const val = this.value.toLowerCase();
    tbody.querySelectorAll('tr').forEach(row=>{
        const nama = row.querySelector('.nama').value.toLowerCase();
        row.style.display = nama.includes(val)?'':'none';
    });
});

// Sort kolom Total (klik header)
document.querySelectorAll('th').forEach((th,index)=>{
    if(index===6){ // kolom Total
        th.addEventListener('click', ()=>{
            let rows = Array.from(tbody.querySelectorAll('tr'));
            rows.sort((a,b)=> parseFloat(b.querySelector('.total').value) - parseFloat(a.querySelector('.total').value));
            rows.forEach(r=>tbody.appendChild(r));
        });
    }
});
</script>
</body>
</html>
